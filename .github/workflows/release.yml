name: release

on:
  push:
    tags:
      - "v*"

jobs:
  build-native:
    name: Build Rust native (${{ matrix.rid }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            target: x86_64-pc-windows-msvc
            artifact_name: rust_cache.dll
            dest_path: LiteAPI.Cache/runtimes/win-x64/native/rust_cache.dll
          - os: windows-latest
            rid: win-arm64
            target: aarch64-pc-windows-msvc
            artifact_name: rust_cache.dll
            dest_path: LiteAPI.Cache/runtimes/win-arm64/native/rust_cache.dll
          - os: ubuntu-latest
            rid: linux-x64
            target: x86_64-unknown-linux-gnu
            artifact_name: librust_cache.so
            dest_path: LiteAPI.Cache/runtimes/linux-x64/native/librust_cache.so
          - os: ubuntu-latest
            rid: linux-arm64
            target: aarch64-unknown-linux-gnu
            artifact_name: librust_cache.so
            dest_path: LiteAPI.Cache/runtimes/linux-arm64/native/librust_cache.so
          - os: macos-15-intel
            rid: osx-x64
            target: x86_64-apple-darwin
            artifact_name: librust_cache.dylib
            dest_path: LiteAPI.Cache/runtimes/osx-x64/native/librust_cache.dylib
          - os: macos-latest
            rid: osx-arm64
            target: aarch64-apple-darwin
            artifact_name: librust_cache.dylib
            dest_path: LiteAPI.Cache/runtimes/osx-arm64/native/librust_cache.dylib

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux cross deps
        if: runner.os == 'Linux' && matrix.rid == 'linux-arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu

      - name: Build (release)
        working-directory: RustLib
        shell: bash
        run: |
          set -euo pipefail

          # For linux-arm64 we must explicitly use the aarch64 linker.
          if [[ "${{ matrix.rid }}" == "linux-arm64" ]]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
            export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
            export AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar
          fi

          cargo build --release --target "${{ matrix.target }}"

      - name: Copy native into runtimes/
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "${{ matrix.dest_path }}")"

          # Windows puts the dll under deps
          if [[ "${{ matrix.rid }}" == win-* ]]; then
            src1="RustLib/target/${{ matrix.target }}/release/deps/${{ matrix.artifact_name }}"
            src2="RustLib/target/${{ matrix.target }}/release/${{ matrix.artifact_name }}"
            if [[ -f "$src1" ]]; then
              cp "$src1" "${{ matrix.dest_path }}"
            elif [[ -f "$src2" ]]; then
              cp "$src2" "${{ matrix.dest_path }}"
            else
              echo "Native output not found" >&2
              exit 1
            fi
          else
            cp "RustLib/target/${{ matrix.target }}/release/${{ matrix.artifact_name }}" "${{ matrix.dest_path }}"
          fi

      - name: Upload native artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.rid }}
          path: ${{ matrix.dest_path }}
          if-no-files-found: error

  pack:
    name: Pack NuGet (cross-platform natives)
    needs: build-native
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Download native artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          merge-multiple: false
          path: .native-artifacts

      - name: Place natives into runtimes/
        shell: bash
        run: |
          set -euo pipefail

          declare -a rids=(
            win-x64 win-arm64
            linux-x64 linux-arm64
            osx-x64 osx-arm64
          )

          placed=0
          for rid in "${rids[@]}"; do
            case "$rid" in
              win-*) file="rust_cache.dll";;
              linux-*) file="librust_cache.so";;
              osx-*) file="librust_cache.dylib";;
              *) echo "Unknown rid: $rid" >&2; exit 1;;
            esac

            src=".native-artifacts/native-${rid}/${file}"
            dest="LiteAPI.Cache/runtimes/${rid}/native/${file}"
            if [[ -f "$src" ]]; then
              mkdir -p "$(dirname "$dest")"
              cp "$src" "$dest"
              placed=$((placed+1))
            else
              echo "Missing native artifact: $src" >&2
            fi
          done

          if [[ "$placed" -eq 0 ]]; then
            echo "No native runtime files were placed. Downloaded artifacts:" >&2
            find .native-artifacts -maxdepth 3 -type f -print >&2 || true
            exit 1
          fi

      - name: Restore
        run: dotnet restore "./LiteAPI.Cache.sln"

      - name: Build
        run: dotnet build "./LiteAPI.Cache.sln" --configuration Release --no-restore

      - name: Verify (Linux)
        run: |
          dotnet run --project "./TestApp/TestApp.csproj" -c Release -- phase1
          dotnet run --project "./TestApp/TestApp.csproj" -c Release -- phase2
          dotnet run --project "./TestApp/TestApp.csproj" -c Release -- phase3
          dotnet run --project "./TestApp/TestApp.csproj" -c Release -- phase4

      - name: Pack
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          dotnet pack "./LiteAPI.Cache/LiteAPI.Cache.csproj" --configuration Release --no-build -p:PackageVersion="$version"

      - name: Upload nupkg
        uses: actions/upload-artifact@v4
        with:
          name: nupkg
          path: LiteAPI.Cache/bin/Release/*.nupkg
          if-no-files-found: error

  push-nuget:
    name: Push to NuGet
    needs: pack
    runs-on: ubuntu-latest
    env:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

    steps:
      - name: Skip (no NuGet key)
        if: ${{ env.NUGET_API_KEY == '' }}
        run: echo "NUGET_API_KEY is not set; skipping NuGet push."

      - uses: actions/download-artifact@v4
        if: ${{ env.NUGET_API_KEY != '' }}
        with:
          name: nupkg
          path: nupkg

      - uses: actions/setup-dotnet@v4
        if: ${{ env.NUGET_API_KEY != '' }}
        with:
          dotnet-version: 9.0.x

      - name: Push
        if: ${{ env.NUGET_API_KEY != '' }}
        run: dotnet nuget push "nupkg/*.nupkg" --api-key "$NUGET_API_KEY" --source "https://api.nuget.org/v3/index.json" --skip-duplicate
